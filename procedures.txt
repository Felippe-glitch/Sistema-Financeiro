







CREATE PROCEDURE auditoriaDuplicatas
	@NOME VARCHAR(50), @TIPO INT
AS
BEGIN 
	IF @TIPO = 0
		SELECT P.id_pagar AS ID,
		P.data_emissao AS Data_Emissao,
		P.data_vencimento AS Data_Vencimento,
		P.descricao_pagar AS Descricao,
		E.razao_social AS Nome_Empresa,
		C.conta AS Num_Conta
		FROM PAGAR P 
		INNER JOIN empresa E ON P.fk_empresa = E.id_empresa
		INNER JOIN conta C ON P.fk_conta = C.id_conta
		WHERE P.usuario LIKE '%' + @NOME +'%'
	ELSE IF @TIPO = 1
		SELECT R.id_receber AS ID,
		R.data_emissao AS Data_Emissao,
		R.data_vencimento AS Data_Vencimento,
		R.descricao_receber AS Descricao,
		E.razao_social AS Nome_Empresa,
		C.conta AS Num_Conta
		FROM RECEBER R 
		INNER JOIN empresa E ON R.fk_empresa = E.id_empresa
		INNER JOIN conta C ON R.fk_conta = C.id_conta
		WHERE R.usuario LIKE '%' + @NOME +'%'
END 
GO








CREATE PROCEDURE extratoConta
    @id_conta BIGINT 
AS 
BEGIN 
    SELECT 
        C.conta AS Numero_Conta,
        B.nome_banco AS Nome_Banco,
        ISNULL(SUM(CASE WHEN M.tipo_duplicata = 0 THEN M.valor_mov ELSE 0 END), 0) AS Total_Recebido,
        ISNULL(SUM(CASE WHEN M.tipo_duplicata = 1 THEN M.valor_mov ELSE 0 END), 0) AS Total_Pago,
        C.saldo
    FROM movimentacao M
    INNER JOIN CONTA C ON M.FK_CONTA = C.ID_CONTA
    INNER JOIN BANCO B ON C.fk_banco = B.id_banco
    WHERE C.id_conta = @id_conta
    GROUP BY C.conta, B.nome_banco, C.saldo
END
Go











CREATE PROCEDURE extratoFornecedor @id_empresa bigint
AS
BEGIN 
    SELECT  
        usuario as Usuario, 
        id_pagar as ID_Movimento, 
        data_emissao as Data_Emissao, 
        data_vencimento as Data_Vencimento, 
        descricao_pagar as Descricao, 
        valor_pagar as Valor, 
        fk_empresa as ID_Empresa, 
        fk_conta as FK_Banco
    FROM pagar 
    WHERE fk_empresa = @id_empresa 
  
END
GO






CREATE PROCEDURE extratoAmbos @id_empresa bigint
AS
BEGIN 
    SELECT  
        usuario, 
        id_pagar, 
        data_emissao, 
        data_vencimento, 
        descricao_pagar, 
        valor_pagar, 
        fk_empresa, 
        fk_conta
    FROM pagar 

	UNION ALL

	SELECT  
        usuario as Usuario, 
        id_receber as ID_Movimento, 
        data_emissao as Data_Emissao, 
        data_vencimento as Data_Vencimento, 
        descricao_receber as Descricao, 
        valor_receber as Valor, 
        fk_empresa as ID_Empresa, 
        fk_conta as FK_Banco
    FROM receber

	WHERE fk_empresa = @id_empresa 
	
  
END
GO











CREATE PROCEDURE extratoCliente @id_empresa bigint
AS
BEGIN 
    SELECT  
        usuario as Usuario, 
        id_receber as ID_Movimento, 
        data_emissao as Data_Emissao, 
        data_vencimento as Data_Vencimento, 
        descricao_receber as Descricao, 
        valor_receber as Valor, 
        fk_empresa as ID_Empresa, 
        fk_conta as FK_Banco
    FROM receber
    WHERE fk_empresa = @id_empresa 
END
GO











CREATE PROCEDURE extratoDiario
AS
BEGIN
    SELECT 
        'Pago' AS Tipo,  
        SUM(valor_mov) AS Valor
    FROM movimentacao 
    WHERE CAST(data_registro_movimentacao AS DATE) = CAST(GETDATE() AS DATE) 
      AND tipo_duplicata = 0

    UNION ALL

    SELECT 
        'Recebido' AS Tipo,  
        SUM(valor_mov) AS Valor
    FROM movimentacao 
    WHERE CAST(data_registro_movimentacao AS DATE) = CAST(GETDATE() AS DATE) 
      AND tipo_duplicata = 1
END
go






CREATE PROCEDURE extratoPeriodo
    @DataInicio DATE,
    @DataFim DATE
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        'Pago' AS Tipo,  
        SUM(valor_mov) AS Valor
    FROM movimentacao 
    WHERE CAST(data_registro_movimentacao AS DATE) BETWEEN @DataInicio AND @DataFim
      AND tipo_duplicata = 0

    UNION ALL

    SELECT 
        'Recebido' AS Tipo,  
        SUM(valor_mov) AS Valor
    FROM movimentacao 
    WHERE CAST(data_registro_movimentacao AS DATE) BETWEEN @DataInicio AND @DataFim
      AND tipo_duplicata = 1
END
GO








CREATE TRIGGER tr_gerarMovimentacaoPagar 
ON pagar 
AFTER UPDATE 
AS 
BEGIN 
    DECLARE @FPAG VARCHAR(20);
    DECLARE @TIPOD INT;
    DECLARE @USUARIO VARCHAR(100);
    DECLARE @VALOR NUMERIC(18,2);
    DECLARE @FKCONTA BIGINT;
    DECLARE @DATAVERIF DATE;

    SELECT 
        @FPAG = forma_pagamento, 
        @TIPOD = 0, 
        @USUARIO = usuario, 
        @VALOR = valor_pagar, 
        @FKCONTA = fk_conta, 
        @DATAVERIF = data_pagamento 
    FROM INSERTED;

    IF @DATAVERIF IS NOT NULL 
        INSERT INTO movimentacao (
            data_registro_movimentacao, 
            forma_pagamento, 
            tipo_duplicata, 
            usuario_cad, 
            valor_mov, 
            fk_conta
        ) 
        VALUES (
            GETDATE(), 
            @FPAG, 
            @TIPOD, 
            @USUARIO, 
            @VALOR, 
            @FKCONTA
        );
END;
GO





CREATE TRIGGER tr_gerarMovimentacaoReceber 
ON receber 
AFTER UPDATE 
AS 
BEGIN 
    DECLARE @FPAG VARCHAR(20);
    DECLARE @TIPOD INT;
    DECLARE @USUARIO VARCHAR(100);
    DECLARE @VALOR NUMERIC(18,2);
    DECLARE @FKCONTA BIGINT;
    DECLARE @DATAVERIF DATE;

    SELECT 
        @FPAG = forma_pagamento, 
        @TIPOD = 1, 
        @USUARIO = usuario, 
        @VALOR = valor_receber, 
        @FKCONTA = fk_conta, 
        @DATAVERIF = data_recebimento 
    FROM INSERTED;

    IF @DATAVERIF IS NOT NULL 
        INSERT INTO movimentacao (
            data_registro_movimentacao, 
            forma_pagamento, 
            tipo_duplicata, 
            usuario_cad, 
            valor_mov, 
            fk_conta
        ) 
        VALUES (
            GETDATE(), 
            @FPAG, 
            @TIPOD, 
            @USUARIO, 
            @VALOR, 
            @FKCONTA
        );
END;
GO






CREATE TRIGGER tr_atualizaSaldo
ON movimentacao
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE c
    SET c.saldo =
        CASE 
            WHEN i.tipo_duplicata = 0 THEN c.saldo - i.valor_mov  
            WHEN i.tipo_duplicata = 1 THEN c.saldo + i.valor_mov  
            ELSE c.saldo
        END
    FROM conta c
    INNER JOIN inserted i ON c.id_conta = i.fk_conta;
END
GO











CREATE PROCEDURE getUsuario
    @id_usuario bigint
AS
BEGIN

    SELECT *
    FROM usuario
    WHERE id_usuario = @id_usuario;
END;
GO

CREATE PROCEDURE getConta
    @id_conta bigint
AS
BEGIN

    SELECT *
    FROM conta
    WHERE id_conta = @id_conta;
END;

GO

CREATE PROCEDURE getBanco
    @id_banco bigint
AS
BEGIN

    SELECT *
    FROM banco
    WHERE id_banco = @id_banco;
END;
GO

CREATE PROCEDURE getReceber
    @id_receber bigint
AS
BEGIN

    SELECT *
    FROM receber
    WHERE id_receber = @id_receber;
END;
GO

CREATE PROCEDURE getPagar
    @id_pagar bigint
AS
BEGIN

    SELECT *
    FROM pagar
    WHERE id_pagar = @id_pagar;
END;
GO

CREATE PROCEDURE getMovimentacao
    @id_movimentacao bigint
AS
BEGIN

    SELECT *
    FROM movimentacao
    WHERE id_movimentacao = @id_movimentacao;
END;
GO

CREATE PROCEDURE getEmpresa
 @id_empresa  bigint
AS BEGIN
    SELECT	* 
    FROM empresa
    WHERE @id_empresa =Â id_empresa
End
GO



