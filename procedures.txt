
CREATE PROCEDURE auditoriaMovimentacoes
    @NOME VARCHAR(50),          
    @DATA DATE
AS
BEGIN 
    SELECT * FROM movimentacao
    WHERE usuario_cad LIKE '%' + @NOME + '%'
    AND data_registro_movimentacao > = @DATA
END













CREATE PROCEDURE auditoriaDuplicatas
    @NOME VARCHAR(50),
    @TIPO INT,                 -- 0 = PAGAR, 1 = RECEBER, 2 = AMBOS
    @DATA_INICIO DATE = NULL,
    @DATA_FIM DATE = NULL
AS
BEGIN 
    SET NOCOUNT ON;

    IF @TIPO = 0
    BEGIN
        SELECT  
            id_pagar AS id_movimento,
            data_emissao,
            data_vencimento,
            descricao_pagar AS descricao,
            fk_empresa,
            fk_conta,
            'PAGAR' AS tipo
        FROM PAGAR
        WHERE usuario LIKE '%' + @NOME + '%'
          AND (data_emissao >= @DATA_INICIO)
          AND (data_vencimento <= @DATA_FIM)
    END

    ELSE IF @TIPO = 1
    BEGIN
        SELECT  
            id_receber AS id_movimento,
            data_emissao,
            data_vencimento,
            descricao_receber AS descricao,
            fk_empresa,
            fk_conta,
            'RECEBER' AS tipo
        FROM RECEBER
        WHERE usuario LIKE '%' + @NOME + '%'
          AND (data_emissao >= @DATA_INICIO)
          AND (data_vencimento <= @DATA_FIM)
    END

    ELSE IF @TIPO = 2
    BEGIN
        SELECT  
            id_pagar AS id_movimento,
            data_emissao,
            data_vencimento,
            descricao_pagar AS descricao,
            fk_empresa,
            fk_conta,
            'PAGAR' AS tipo
        FROM PAGAR
        WHERE usuario LIKE '%' + @NOME + '%'
          AND (data_emissao >= @DATA_INICIO)
          AND (data_vencimento <= @DATA_FIM)

        UNION ALL

        SELECT  
            id_receber AS id_movimento,
            data_emissao,
            data_vencimento,
            descricao_receber AS descricao,
            fk_empresa,
            fk_conta,
            'RECEBER' AS tipo
        FROM RECEBER
        WHERE usuario LIKE '%' + @NOME + '%'
          AND (data_emissao >= @DATA_INICIO)
          AND (data_vencimento <= @DATA_FIM)
    END
END
GO









CREATE PROCEDURE extratoConta
    @id_conta BIGINT 
AS 
BEGIN 
    SELECT 
        C.conta AS Numero_Conta,
        B.nome_banco AS Nome_Banco,
        ISNULL(SUM(CASE WHEN M.tipo_duplicata = 0 THEN M.valor_mov ELSE 0 END), 0) AS Total_Recebido,
        ISNULL(SUM(CASE WHEN M.tipo_duplicata = 1 THEN M.valor_mov ELSE 0 END), 0) AS Total_Pago,
        C.saldo
    FROM movimentacao M
    INNER JOIN CONTA C ON M.FK_CONTA = C.ID_CONTA
    INNER JOIN BANCO B ON C.fk_banco = B.id_banco
    WHERE C.id_conta = @id_conta
    GROUP BY C.conta, B.nome_banco, C.saldo
END
Go











CREATE PROCEDURE extratoFornecedor @id_empresa bigint
AS
BEGIN 
    SELECT  
        *
    FROM pagar 
    WHERE fk_empresa = @id_empresa 
END
GO






CREATE PROCEDURE extratoAmbos 
    @id_empresa BIGINT,
    @data_inicio DATE,
    @data_fim DATE
AS
BEGIN 
    SELECT  
        usuario, 
        id_pagar AS id_movimento,
        data_emissao, 
        data_vencimento, 
        descricao_pagar AS descricao,
        valor_pagar AS valor,
        fk_empresa, 
        fk_conta,
        'PAGAR' AS tipo
    FROM pagar
    WHERE fk_empresa = @id_empresa
      AND data_emissao >= @data_inicio
      AND data_vencimento <= @data_fim

    UNION ALL

    SELECT  
        usuario, 
        id_receber AS id_movimento,
        data_emissao, 
        data_vencimento, 
        descricao_receber AS descricao,
        valor_receber AS valor,
        fk_empresa, 
        fk_conta,
        'RECEBER' AS tipo
    FROM receber
    WHERE fk_empresa = @id_empresa
      AND data_emissao >= @data_inicio
      AND data_vencimento <= @data_fim
END
GO











CREATE PROCEDURE extratoCliente 
    @id_empresa bigint, @data_inicio DATE, @data_fim DATE
AS
BEGIN 
    SELECT  
        usuario, 
        id_receber, 
        data_emissao, 
        data_vencimento, 
        descricao_receber, 
        valor_receber, 
        fk_empresa, 
        fk_conta
    FROM receber
    WHERE fk_empresa = @id_empresa AND data_emissao >= @data_inicio AND data_vencimento <= @data_fim
END
GO











CREATE PROCEDURE extratoDiario
AS
BEGIN
    SELECT 
        'Pago' AS Tipo,  
        SUM(valor_mov) AS Valor
    FROM movimentacao 
    WHERE CAST(data_registro_movimentacao AS DATE) = CAST(GETDATE() AS DATE) 
      AND tipo_duplicata = 0

    UNION ALL

    SELECT 
        'Recebido' AS Tipo,  
        SUM(valor_mov) AS Valor
    FROM movimentacao 
    WHERE CAST(data_registro_movimentacao AS DATE) = CAST(GETDATE() AS DATE) 
      AND tipo_duplicata = 1
END
go






CREATE PROCEDURE extratoPeriodo
    @DataInicio DATE,
    @DataFim DATE
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        'Pago' AS Tipo,  
        SUM(valor_mov) AS Valor
    FROM movimentacao 
    WHERE CAST(data_registro_movimentacao AS DATE) BETWEEN @DataInicio AND @DataFim
      AND tipo_duplicata = 0

    UNION ALL

    SELECT 
        'Recebido' AS Tipo,  
        SUM(valor_mov) AS Valor
    FROM movimentacao 
    WHERE CAST(data_registro_movimentacao AS DATE) BETWEEN @DataInicio AND @DataFim
      AND tipo_duplicata = 1
END
GO








CREATE TRIGGER tr_gerarMovimentacaoPagar 
ON pagar 
AFTER UPDATE, INSERT
AS 
BEGIN 
    DECLARE @FPAG VARCHAR(20);
    DECLARE @TIPOD INT;
    DECLARE @USUARIO VARCHAR(100);
    DECLARE @VALOR NUMERIC(18,2);
    DECLARE @FKCONTA BIGINT;
    DECLARE @DATAVERIF DATE;

    SELECT 
        @FPAG = forma_pagamento, 
        @TIPOD = 0, 
        @USUARIO = usuario, 
        @VALOR = valor_pagar, 
        @FKCONTA = fk_conta, 
        @DATAVERIF = data_pagamento 
    FROM INSERTED;

    IF @DATAVERIF IS NOT NULL 
        INSERT INTO movimentacao (
            data_registro_movimentacao, 
            forma_pagamento, 
            tipo_duplicata, 
            usuario_cad, 
            valor_mov, 
            fk_conta
        ) 
        VALUES (
            GETDATE(), 
            @FPAG, 
            @TIPOD, 
            @USUARIO, 
            @VALOR, 
            @FKCONTA
        );
END;
GO





CREATE TRIGGER tr_gerarMovimentacaoReceber 
ON receber 
AFTER UPDATE, INSERT
AS 
BEGIN 
    DECLARE @FPAG VARCHAR(20);
    DECLARE @TIPOD INT;
    DECLARE @USUARIO VARCHAR(100);
    DECLARE @VALOR NUMERIC(18,2);
    DECLARE @FKCONTA BIGINT;
    DECLARE @DATAVERIF DATE;

    SELECT 
        @FPAG = forma_pagamento, 
        @TIPOD = 1, 
        @USUARIO = usuario, 
        @VALOR = valor_receber, 
        @FKCONTA = fk_conta, 
        @DATAVERIF = data_recebimento 
    FROM INSERTED;

    IF @DATAVERIF IS NOT NULL 
        INSERT INTO movimentacao (
            data_registro_movimentacao, 
            forma_pagamento, 
            tipo_duplicata, 
            usuario_cad, 
            valor_mov, 
            fk_conta
        ) 
        VALUES (
            GETDATE(), 
            @FPAG, 
            @TIPOD, 
            @USUARIO, 
            @VALOR, 
            @FKCONTA
        );
END;
GO






CREATE TRIGGER tr_atualizaSaldo
ON movimentacao
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE c
    SET c.saldo =
        CASE 
            WHEN i.tipo_duplicata = 0 THEN c.saldo - i.valor_mov  
            WHEN i.tipo_duplicata = 1 THEN c.saldo + i.valor_mov  
            ELSE c.saldo
        END
    FROM conta c
    INNER JOIN inserted i ON c.id_conta = i.fk_conta;
END
GO











CREATE PROCEDURE getUsuario
    @id_usuario bigint
AS
BEGIN

    SELECT *
    FROM usuario
    WHERE id_usuario = @id_usuario;
END;
GO

CREATE PROCEDURE getConta
    @id_conta bigint
AS
BEGIN

    SELECT *
    FROM conta
    WHERE id_conta = @id_conta;
END;

GO

CREATE PROCEDURE getBanco
    @id_banco bigint
AS
BEGIN

    SELECT *
    FROM banco
    WHERE id_banco = @id_banco;
END;
GO

CREATE PROCEDURE getReceber
    @id_receber bigint
AS
BEGIN

    SELECT *
    FROM receber
    WHERE id_receber = @id_receber;
END;
GO

CREATE PROCEDURE getPagar
    @id_pagar bigint
AS
BEGIN

    SELECT *
    FROM pagar
    WHERE id_pagar = @id_pagar;
END;
GO

CREATE PROCEDURE getMovimentacao
    @id_movimentacao bigint
AS
BEGIN

    SELECT *
    FROM movimentacao
    WHERE id_movimentacao = @id_movimentacao;
END;
GO

CREATE PROCEDURE getEmpresa
 @id_empresa  bigint
AS BEGIN
    SELECT	* 
    FROM empresa
    WHERE @id_empresa =Â id_empresa
End
GO




